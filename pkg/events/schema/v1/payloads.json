{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Event Payload Schemas v1",
  "description": "JSON schemas for all event payload types",
  "definitions": {
    "extractRequest": {
      "type": "object",
      "required": ["app_id", "app_name", "countries", "date_from", "date_to"],
      "properties": {
        "app_id": {
          "type": "string",
          "description": "Application identifier"
        },
        "app_name": {
          "type": "string",
          "description": "Application name"
        },
        "countries": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^[A-Z]{2}$"
          },
          "minItems": 1,
          "description": "ISO-2 country codes"
        },
        "date_from": {
          "type": "string",
          "pattern": "^\\d{4}-\\d{2}-\\d{2}$",
          "description": "Start date in YYYY-MM-DD format"
        },
        "date_to": {
          "type": "string",
          "pattern": "^\\d{4}-\\d{2}-\\d{2}$",
          "description": "End date in YYYY-MM-DD format"
        }
      }
    },
    "extractCompleted": {
      "allOf": [
        { "$ref": "#/definitions/extractRequest" },
        {
          "type": "object",
          "required": ["count"],
          "properties": {
            "count": {
              "type": "integer",
              "minimum": 0,
              "description": "Number of reviews extracted"
            }
          }
        }
      ]
    },
    "prepareCompleted": {
      "allOf": [
        { "$ref": "#/definitions/extractRequest" },
        {
          "type": "object",
          "required": ["count", "clean_count"],
          "properties": {
            "count": {
              "type": "integer",
              "minimum": 0,
              "description": "Total number of reviews"
            },
            "clean_count": {
              "type": "integer",
              "minimum": 0,
              "description": "Number of clean/processed reviews"
            }
          }
        }
      ]
    },
    "failed": {
      "type": "object",
      "required": ["step", "code", "recoverable", "details", "context"],
      "properties": {
        "step": {
          "type": "string",
          "enum": ["extract", "prepare"],
          "description": "Pipeline step that failed"
        },
        "code": {
          "type": "string",
          "enum": [
            "SOURCE_UNAVAILABLE",
            "RATE_LIMIT",
            "AUTH_FAILED",
            "TEMP_STORAGE_UNAVAILABLE",
            "WRITE_FAILED",
            "VALIDATION_ERROR",
            "SCHEMA_MISMATCH",
            "UNKNOWN"
          ],
          "description": "Error code"
        },
        "recoverable": {
          "type": "boolean",
          "description": "Whether the error is recoverable"
        },
        "details": {
          "type": "string",
          "description": "Human-readable error details"
        },
        "context": {
          "type": "object",
          "required": ["app_id", "countries"],
          "properties": {
            "app_id": {
              "type": "string",
              "description": "Application identifier"
            },
            "countries": {
              "type": "array",
              "items": {
                "type": "string",
                "pattern": "^[A-Z]{2}$"
              },
              "description": "Country codes"
            }
          }
        }
      }
    },
    "stateChanged": {
      "type": "object",
      "required": ["status", "step", "context"],
      "properties": {
        "status": {
          "type": "string",
          "enum": ["running", "failed", "completed"],
          "description": "Current saga status"
        },
        "step": {
          "type": "string",
          "enum": ["extract", "prepare"],
          "description": "Current saga step"
        },
        "context": {
          "type": "object",
          "required": ["message", "count"],
          "properties": {
            "message": {
              "type": "string",
              "description": "Status message"
            },
            "count": {
              "type": "integer",
              "description": "Count information"
            }
          }
        },
        "error": {
          "type": "object",
          "required": ["code", "message"],
          "properties": {
            "code": {
              "type": "string",
              "description": "Error code"
            },
            "message": {
              "type": "string",
              "description": "Error message"
            }
          }
        }
      }
    }
  }
}
